<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>S4SOLUTION â€¢ Titulares</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body { background:#f4f6f9; }
header { background:#111827; color:#fff; }
body { background:#f4f6f9; font-family: Arial, sans-serif; }
header { background:#111827; color:#fff; }
header a { color:#fff; text-decoration:none; transition:0.3s; }
header a:hover { color:#60a5fa; }
.encomenda-foto {
  width:100px;
  height:100px;
  object-fit:cover;
  border-radius:6px;
}

@media (max-width:576px){
  .encomenda-foto{width:80px;height:80px;}
}
</style>
</head>

<body>

<header class="py-3 mb-4">
  <div class="container d-flex justify-content-between align-items-center">
    <h2 class="fw-bold mb-0">S4SOLUTION</h2>
    <nav class="d-flex gap-3">
      <a href="index.html">InÃ­cio</a>
      <a href="encomendas.html">Encomendas</a>
      <a href="titulares.html">Titulares</a>
    </nav>
  </div>
</header>

<main class="container">

<!-- CADASTRO -->
<div class="card shadow p-4 mb-4">
  <h5>Cadastro de Titulares</h5>

  <form id="formTitular">
    <input class="form-control mb-2" name="nome" placeholder="Nome" required>
    <input class="form-control mb-2" name="bloco" placeholder="Bloco" required>
    <input class="form-control mb-2" name="casa" placeholder="Casa" required>
    <input class="form-control mb-2" id="telefone" placeholder="Telefone (somente nÃºmeros) - 558499988776" required>
    <button class="btn btn-primary w-100">Salvar</button>
  </form>
</div>

<!-- LISTA -->
<div class="card shadow p-4">
  <h5>Lista de Titulares</h5>
  <ul id="listaTitulares" class="list-group mt-3"></ul>
</div>

</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs,
  deleteDoc, doc, updateDoc, query, where
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyDQVdWTpDvXZqgawxnrxRWtG7HD02VxKDI",
  authDomain: "s4solution-7466a.firebaseapp.com",
  projectId: "s4solution-7466a",
  storageBucket: "s4solution-7466a.firebasestorage.app",
  messagingSenderId: "365611705854",
  appId: "1:365611705854:web:054b6de3849793b1294caf"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const listaTitulares = document.getElementById("listaTitulares");
const form = document.getElementById("formTitular");
const telefoneInput = document.getElementById("telefone");

/* LISTAR TITULARES */
async function listarTitulares(){
  listaTitulares.innerHTML="";
  const snap = await getDocs(collection(db,"titulares"));

  snap.forEach(docu=>{
    const t = docu.data();

    const li=document.createElement("li");
    li.className="list-group-item mb-3";

    li.innerHTML=`
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <b>${t.nome}</b><br>
          Bloco ${t.bloco} â€¢ Casa ${t.casa}<br>
          ðŸ“ž ${t.telefone}
        </div>

        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary btn-sm">Ver encomendas</button>
          <button class="btn btn-outline-danger btn-sm"
            onclick="excluirTitular('${docu.id}','${t.nome}')">
            Excluir titular
          </button>
        </div>
      </div>

      <ul class="list-group mt-3 d-none" id="enc-${docu.id}"></ul>
    `;

    const btn = li.querySelector(".btn-outline-primary");
    const listaEnc = li.querySelector(`#enc-${docu.id}`);

    btn.onclick = async ()=>{
      if(!listaEnc.classList.contains("d-none")){
        listaEnc.classList.add("d-none");
        btn.textContent="Ver encomendas";
        return;
      }

      btn.textContent="Ocultar encomendas";
      listaEnc.classList.remove("d-none");
      listaEnc.innerHTML="<li class='list-group-item text-muted'>Carregando...</li>";

      const q=query(
        collection(db,"encomendas"),
        where("titularId","==",docu.id)
      );

      const encSnap=await getDocs(q);
      listaEnc.innerHTML="";

      if(encSnap.empty){
        listaEnc.innerHTML="<li class='list-group-item text-muted'>Nenhuma encomenda</li>";
        return;
      }

      encSnap.forEach(d=>{
        const e=d.data();
        const recebido=e.criadoEm?e.criadoEm.toDate().toLocaleString():"â€”";
        const retirado=e.retiradoEm?e.retiradoEm.toDate().toLocaleString():null;

        listaEnc.innerHTML+=`
          <li class="list-group-item">
            <div class="d-flex flex-column flex-md-row gap-3">
              <img src="${e.foto}" class="encomenda-foto">
              <div class="flex-fill">
                <b>${e.produto}</b><br>
                Recebido em: ${recebido}<br>
                Status: ${e.status}<br>

                ${
                  e.status==="Aguardando retirada"
                  ? `<input class="form-control mt-2" id="c${d.id}" placeholder="CÃ³digo">
                     <button class="btn btn-success btn-sm mt-2"
                       onclick="validar('${d.id}','${e.codigo}')">Validar</button>`
                  : `Retirado em: ${retirado}`
                }

                <button class="btn btn-danger btn-sm mt-2"
                  onclick="excluirEncomenda('${d.id}')">Excluir encomenda</button>
              </div>
            </div>
          </li>
        `;
      });
    };

    listaTitulares.appendChild(li);
  });
}

/* CADASTRAR TITULAR */
form.onsubmit=async e=>{
  e.preventDefault();

  if(!/^\d{10,18}$/.test(telefoneInput.value)){
    alert("Telefone invÃ¡lido");
    return;
  }

  await addDoc(collection(db,"titulares"),{
    nome:form.nome.value,
    bloco:form.bloco.value,
    casa:form.casa.value,
    telefone:telefoneInput.value
  });

  form.reset();
  listarTitulares();
};

/* VALIDAR ENCOMENDA */
window.validar=async(id,codigo)=>{
  if(document.getElementById("c"+id).value!==codigo){
    alert("CÃ³digo invÃ¡lido");
    return;
  }
  await updateDoc(doc(db,"encomendas",id),{
    status:"Retirado",
    retiradoEm:new Date()
  });
  listarTitulares();
};

/* EXCLUIR ENCOMENDA */
window.excluirEncomenda=async id=>{
  if(!confirm("Excluir esta encomenda?")) return;
  await deleteDoc(doc(db,"encomendas",id));
  listarTitulares();
};

/* EXCLUIR TITULAR + ENCOMENDAS */
window.excluirTitular=async(titularId,nome)=>{
  const ok=confirm(
    `Excluir o titular "${nome}"?\n\n`+
    `Todas as encomendas desse titular tambÃ©m serÃ£o removidas.`
  );
  if(!ok) return;

  const q=query(
    collection(db,"encomendas"),
    where("titularId","==",titularId)
  );
  const snap=await getDocs(q);

  for(const d of snap.docs){
    await deleteDoc(doc(db,"encomendas",d.id));
  }

  await deleteDoc(doc(db,"titulares",titularId));
  listarTitulares();
};

listarTitulares();
</script>

</body>
</html>
