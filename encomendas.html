<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>S4SOLUTION • Encomendas</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<style>
body { background:#f4f6f9; }
header { background:#111827; color:#fff; }
.card { border:none; border-radius:14px; }
#scanner, #camera { width:100%; height:200px; display:none; border-radius:10px; margin-top:10px; background:#000; object-fit:cover; }
.list-group-item { cursor:pointer; }
.encomenda-foto { width:100px; height:100px; object-fit:cover; border-radius:6px; }
@media (max-width: 576px) {
  .encomenda-foto { width:80px; height:80px; }
  .list-group-item { padding:10px; }
}
</style>
</head>
<body>
<header class="py-2 mb-2">
  <div class="container my-3">
    <h2 class="fw-bold">S4SOLUTION</h2>
    <small>Sistema de Controle de Encomendas</small>
  </div>
  <nav class="container mt-3 mb-2 d-flex gap-4">
    <a href="index.html">Início</a>
    <a href="./encomendas.html">Encomendas</a>
    <a href="./titulares.html">Titulares</a>
  </nav>
</header>

<main class="container">
<div class="card shadow p-4 mb-4">
  <h5><i class="bi bi-box-seam"></i> Nova Encomenda</h5>
  <div class="row g-3 mt-2">

    <div class="col-md-6">
      <label class="form-label">Produto</label>
      <input id="produto" class="form-control">
    </div>

    <div class="col-md-6">
      <label class="form-label">Número de Série</label>
      <div class="input-group">
        <input id="serie" class="form-control">
        <button class="btn btn-outline-secondary" id="toggleScannerBtn">
          <i class="bi bi-upc-scan"></i>
        </button>
      </div>
    </div>

    <div class="col-12" id="scanner"></div>

    <div class="col-md-6">
      <label class="form-label">Titular</label>
      <input id="titularInput" class="form-control" autocomplete="off">
      <div id="listaTitulares" class="list-group mt-1"></div>
      <small id="statusTitular"></small>
    </div>

    <div class="col-md-6">
      <label class="form-label">Foto da Encomenda</label>
      <button class="btn btn-outline-primary w-100 mb-2" id="toggleCameraBtn">Abrir/Fechar Câmera</button>
      <button class="btn btn-outline-success w-100 mb-2" id="tirarFotoBtn">Tirar Foto</button>
      <img id="previewFoto" class="img-fluid rounded shadow mb-2" style="display:none;">
      <video id="camera" autoplay class="w-100 rounded"></video>
      <canvas id="fotoCanvas" style="display:none;"></canvas>
    </div>

  </div>
  <button class="btn btn-primary w-100 mt-4" onclick="salvarEncomenda()">Salvar Encomenda</button>
</div>

<div class="card shadow p-4">
  <h5><i class="bi bi-list"></i> Encomendas</h5>
  <ul id="listaEncomendas" class="list-group mt-3"></ul>
</div>
</main>

<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDQVdWTpDvXZqgawxnrxRWtG7HD02VxKDI",
  authDomain: "s4solution-7466a.firebaseapp.com",
  projectId: "s4solution-7466a",
  storageBucket: "s4solution-7466a.firebasestorage.app",
  messagingSenderId: "365611705854",
  appId: "1:365611705854:web:054b6de3849793b1294caf",
  measurementId: "G-HEP3WV471B"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let titularSelecionado = null;
let fotoBase64 = "";
let cameraStream = null;
let scannerAberto = false;
let cameraAberta = false;
let facingMode = "environment";

const camera = document.getElementById("camera");
const fotoCanvas = document.getElementById("fotoCanvas");
const previewFoto = document.getElementById("previewFoto");
const titularInput = document.getElementById("titularInput");
const listaTitulares = document.getElementById("listaTitulares");
const statusTitular = document.getElementById("statusTitular");
const listaEncomendas = document.getElementById("listaEncomendas");
const scannerDiv = document.getElementById("scanner");
const toggleScannerBtn = document.getElementById("toggleScannerBtn");
const toggleCameraBtn = document.getElementById("toggleCameraBtn");
const tirarFotoBtn = document.getElementById("tirarFotoBtn");

// Toggle scanner
toggleScannerBtn.addEventListener("click", ()=>{
  if(scannerAberto){
    Quagga.stop();
    scannerDiv.style.display="none";
    scannerAberto=false;
  } else {
    if(cameraAberta && cameraStream){ cameraStream.getTracks().forEach(t=>t.stop()); camera.style.display="none"; cameraAberta=false; }
    scannerDiv.style.display="block";
    Quagga.init({
      inputStream:{ name:"Live", type:"LiveStream", target:scannerDiv, constraints:{facingMode} },
      decoder:{readers:["code_128_reader","ean_reader","ean_8_reader","upc_reader","upc_e_reader"]}
    }, err=>{
      if(err){ console.error(err); alert("Erro ao iniciar o scanner"); return; }
      Quagga.start();
      scannerAberto=true;
    });
    Quagga.onDetected(result=>{
      if(result && result.codeResult && result.codeResult.code){
        document.getElementById("serie").value=result.codeResult.code;
        Quagga.stop();
        scannerDiv.style.display="none";
        scannerAberto=false;
      }
    });
  }
});

// Toggle câmera de foto
toggleCameraBtn.addEventListener("click", async ()=>{
  if(cameraAberta){
    camera.style.display="none";
    if(cameraStream){ cameraStream.getTracks().forEach(t=>t.stop()); }
    cameraAberta=false;
  } else {
    if(scannerAberto){ Quagga.stop(); scannerDiv.style.display="none"; scannerAberto=false; }
    camera.style.display="block";
    cameraStream = await navigator.mediaDevices.getUserMedia({video:{facingMode}});
    camera.srcObject = cameraStream;
    cameraAberta=true;
  }
});

// Tirar foto e fechar câmera
tirarFotoBtn.addEventListener("click", ()=>{
  if(!cameraAberta) return alert("Abra a câmera primeiro!");
  fotoCanvas.width = camera.videoWidth;
  fotoCanvas.height = camera.videoHeight;
  fotoCanvas.getContext("2d").drawImage(camera,0,0);
  fotoBase64 = fotoCanvas.toDataURL("image/png");
  previewFoto.src = fotoBase64;
  previewFoto.style.display = "block";

  // Fecha a câmera automaticamente
  cameraStream.getTracks().forEach(t=>t.stop());
  camera.style.display = "none";
  cameraAberta = false;
});

// Normalizar texto
function normalizarTexto(texto){ return texto.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase(); }

// Buscar titular
titularInput.addEventListener("input", async ()=>{
  listaTitulares.innerHTML = "";
  titularSelecionado = null;
  const valorInput = normalizarTexto(titularInput.value.trim());
  if(valorInput.length<2) return;
  const snap = await getDocs(collection(db,"titulares"));
  const resultados = [];
  snap.forEach(d=>{
    const nomeNormalizado = normalizarTexto(d.data().nome);
    if(nomeNormalizado.includes(valorInput)) resultados.push({id:d.id,...d.data()});
  });
  if(resultados.length===0){
    statusTitular.textContent = "Titular não cadastrado";
    statusTitular.style.color = "red";
    return;
  }
  statusTitular.textContent = "Selecione um titular";
  statusTitular.style.color = "green";
  resultados.forEach(d=>{
    const btn = document.createElement("button");
    btn.className="list-group-item list-group-item-action";
    btn.textContent=d.nome;
    btn.onclick=()=>{ titularSelecionado={id:d.id,...d}; titularInput.value=d.nome; listaTitulares.innerHTML=""; statusTitular.textContent="Titular selecionado"; };
    listaTitulares.appendChild(btn);
  });
});

// Salvar encomenda e limpar formulário
window.salvarEncomenda = async ()=>{
  if(!titularSelecionado) return alert("Selecione um titular válido");
  if(!fotoBase64) return alert("Tire a foto da encomenda");

  const codigo=Math.random().toString(36).substring(2,8).toUpperCase();
  await addDoc(collection(db,"encomendas"),{
    produto: produto.value,
    serie: serie.value,
    foto: fotoBase64,
    titularId: titularSelecionado.id,
    titularNome: titularSelecionado.nome,
    titularTelefone: titularSelecionado.telefone,
    codigo,
    status: "Aguardando retirada",
    criadoEm: new Date(),
    retiradoEm: null
  });

  // Limpar formulário
  produto.value = "";
  serie.value = "";
  titularInput.value = "";
  listaTitulares.innerHTML = "";
  statusTitular.textContent = "";
  previewFoto.style.display = "none";
  fotoBase64 = "";
  titularSelecionado = null;

  // Fechar câmera se aberta
  if(cameraAberta && cameraStream){ cameraStream.getTracks().forEach(t=>t.stop()); camera.style.display="none"; cameraAberta=false; }

  // Fechar scanner se aberto
  if(scannerAberto){ Quagga.stop(); scannerDiv.style.display="none"; scannerAberto=false; }

  carregarEncomendas();
};

// Listar encomendas
async function carregarEncomendas(){
  listaEncomendas.innerHTML="";
  const snap = await getDocs(collection(db,"encomendas"));
  snap.forEach(d=>{
    const e=d.data();
    const dataRecebimento = e.criadoEm?e.criadoEm.toDate().toLocaleString():"—";
    const dataRetirada = e.retiradoEm?e.retiradoEm.toDate().toLocaleString():null;
    const li=document.createElement("li");
    li.className="list-group-item";
    li.innerHTML=`
      <div class="d-flex flex-column flex-md-row align-items-start gap-3">
        <img src="${e.foto}" class="encomenda-foto" alt="Foto Encomenda">
        <div class="flex-fill">
          <b>${e.produto}</b><br>
          Titular: ${e.titularNome}<br>
          Recebido em: ${dataRecebimento}<br>
          Status: ${e.status}<br>
          ${e.status==="Aguardando retirada"
            ? `<input class="form-control mt-2" id="c${d.id}" placeholder="Código">
               <button class="btn btn-success btn-sm mt-2" onclick="validar('${d.id}','${e.codigo}')">Validar</button>`
            : `Retirado em: ${dataRetirada}`
          }
          <button class="btn btn-danger btn-sm mt-2" onclick="excluir('${d.id}')">Excluir</button>
        </div>
      </div>
    `;
    listaEncomendas.appendChild(li);
  });
}

// Validar retirada
window.validar=async(id,codigo)=>{
  if(document.getElementById("c"+id).value!==codigo) return alert("Código inválido");
  await updateDoc(doc(db,"encomendas",id),{status:"Retirado",retiradoEm:new Date()});
  carregarEncomendas();
};

// Excluir encomenda
window.excluir=async id=>{
  await deleteDoc(doc(db,"encomendas",id));
  carregarEncomendas();
};

carregarEncomendas();
</script>
</body>
</html>
